import sys
import os

import gps_agent_pkg
sys.path.append(os.path.join(
    os.sep.join(gps_agent_pkg.__path__[0].split(os.sep)[:-7]),
    'python',
))
from gps.gui.gps_training_gui import GPSTrainingGUI
from gps.utility.data_logger import DataLogger
from gps.sample.sample_list import SampleList

import pickle
import argparse
import pdb

from gps.proto.gps_pb2 import (
    JOINT_ANGLES,
    JOINT_VELOCITIES,
    END_EFFECTOR_POINTS,
    END_EFFECTOR_POINT_VELOCITIES,
    END_EFFECTOR_POINT_JACOBIANS,
    END_EFFECTOR_POINT_ROT_JACOBIANS,
    END_EFFECTOR_POSITIONS,
    END_EFFECTOR_ROTATIONS,
    END_EFFECTOR_JACOBIANS,
)
import numpy as np
import imp
import matplotlib.pyplot as plt
import math

if __name__ == '__main__':
    parser = argparse.ArgumentParser() 
    parser.add_argument('--sample-pkl', dest='sample_pkl', type=str, help='path to sample pickle generated by gps', required=True)

    args = parser.parse_args()

    with open(args.sample_pkl, 'rb') as f:
        sample_pkl = pickle.load(f)

    sample = sample_pkl[0][0] 


    offset_point_position = sample.get(END_EFFECTOR_POINTS)
    offset_point_lin_vel = sample.get(END_EFFECTOR_POINT_VELOCITIES)
    offset_point_jac_for_lin_vel = sample.get(END_EFFECTOR_POINT_JACOBIANS)
    joint_vel = sample.get(JOINT_VELOCITIES)

    T = joint_vel.shape[0]
    theoretical_lin_vel = []
    for t in range(T):
        v = np.matmul(offset_point_jac_for_lin_vel[t], joint_vel[t]) 
        theoretical_lin_vel.append(v)
    theoretical_lin_vel = np.array(theoretical_lin_vel)

    assert np.allclose(theoretical_lin_vel, offset_point_lin_vel)

    lin_vel_from_differential = np.diff(offset_point_position,axis=0)/(1.0/20)

    number_of_fig = lin_vel_from_differential.shape[1]

    layout = int(math.ceil(math.sqrt(number_of_fig)))
    fig = plt.figure()
    for i in range(number_of_fig):
        ax = fig.add_subplot(layout, layout, i+1)
        ax.plot(lin_vel_from_differential[:, i], label='differential')
        ax.plot(theoretical_lin_vel[:, i], label='theoretical')
        ax.legend()

    plt.show(block=False)


    print 'Press enter to close the figure'
    raw_input()

    plt.close()
